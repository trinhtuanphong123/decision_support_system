name: Frontend UI CI/CD

# Trigger only when frontend files change
on:
  push:
    branches: [ master ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [ master ]
    paths:
      - 'frontend/**'



jobs:
  test:
    name: Test Frontend UI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-frontend-pip-${{ hashFiles('frontend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-frontend-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify project structure
      run: |
        echo "ğŸ“ Checking frontend structure..."
        ls -la
        echo ""
        echo "âœ… Files present:"
        [ -f "app.py" ] && echo "  â€¢ app.py" || echo "  âš ï¸  app.py missing"
        [ -f "requirements.txt" ] && echo "  â€¢ requirements.txt"
        [ -f "Dockerfile" ] && echo "  â€¢ Dockerfile"
        [ -f ".dockerignore" ] && echo "  â€¢ .dockerignore"
    
    - name: Validate Python syntax
      run: |
        if [ -f "app.py" ]; then
          python -m py_compile app.py
          echo "âœ… Python syntax is valid"
        else
          echo "âš ï¸  app.py not found, skipping syntax check"
        fi
      continue-on-error: true
    
    - name: Check Streamlit installation
      run: |
        python -c "import streamlit; print(f'âœ… Streamlit version: {streamlit.__version__}')"
        echo "âœ… Streamlit installed correctly"
    
    - name: Test imports
      run: |
        python -c "
        import streamlit as st
        import requests
        import plotly
        import pandas as pd
        import numpy as np
        print('âœ… All required packages imported successfully')
        "
    
    - name: Lint with flake8 (optional)
      run: |
        pip install flake8
        if [ -f "app.py" ]; then
          flake8 app.py --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 app.py --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        fi
      continue-on-error: true

  docker:
    name: Build Frontend Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      working-directory: frontend
      run: |
        echo "ğŸ³ Building frontend Docker image..."
        docker build -t airbnb-frontend:${{ github.sha }} .
        echo "âœ… Docker image built successfully"
    
    - name: Test Docker image
      run: |
        echo "ğŸš€ Starting frontend container..."
        docker run -d --name frontend-test -p 8501:8501 \
          -e BACKEND_URL=http://localhost:9696 \
          airbnb-frontend:${{ github.sha }}
        
        echo "â³ Waiting for Streamlit to start (30 seconds)..."
        sleep 30
        
        echo "ğŸ” Testing Streamlit health endpoint..."
        # Streamlit has a health check endpoint
        curl -f http://localhost:8501/_stcore/health || (
          echo "âŒ Health check failed!"
          echo "ğŸ“‹ Container logs:"
          docker logs frontend-test
          exit 1
        )
        
        echo "âœ… Streamlit health check passed"
        
        echo "ğŸ” Testing main page..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8501/)
        if [ "$response" = "200" ] || [ "$response" = "302" ]; then
          echo "âœ… Main page accessible (HTTP $response)"
        else
          echo "âŒ Main page failed (HTTP $response)"
          docker logs frontend-test
          exit 1
        fi
        
        echo ""
        echo "ğŸ‰ All Docker tests passed!"
        
        # Cleanup
        docker stop frontend-test
        docker rm frontend-test

  integration:
    name: Integration Test (Frontend + Backend)
    runs-on: ubuntu-latest
    needs: docker
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build both images
      run: |
        echo "ğŸ—ï¸ Building backend..."
        cd backend
        docker build -t airbnb-backend ./backend
        cd ..
        
        echo "ğŸ—ï¸ Building frontend..."
        cd frontend
        docker build -t airbnb-frontend ./frontend
        cd ..
    
    - name: Start backend
      run: |
        docker run -d --name backend \
          -p 9696:9696 \
          airbnb-backend
        
        echo "â³ Waiting for backend..."
        sleep 30
        
        curl -f http://localhost:9696/health || exit 1
        echo "âœ… Backend is running"
    
    - name: Start frontend with backend connection
      run: |
        docker run -d --name frontend \
          -p 8501:8501 \
          -e BACKEND_URL=http://host.docker.internal:9696 \
          --add-host=host.docker.internal:host-gateway \
          airbnb-frontend
        
        echo "â³ Waiting for frontend..."
        sleep 30
        
        curl -f http://localhost:8501/_stcore/health || exit 1
        echo "âœ… Frontend is running"
    
    - name: Test integration
      run: |
        echo "ğŸ”— Testing frontend-backend communication..."
        
        # Frontend should be able to reach backend
        docker exec frontend curl -f http://host.docker.internal:9696/health || (
          echo "âŒ Integration Failed: Frontend cannot talk to Backend"
          docker logs backend
          exit 1
        )
        
        echo "âœ… Integration test passed"
    
    - name: Cleanup
      if: always()
      run: |
        docker stop frontend backend || true
        docker rm frontend backend || true

  deploy:
    name: Deploy Frontend to Render
    runs-on: ubuntu-latest
    needs: [test, docker, integration]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: Trigger Deploy Hook
      run: |
        echo "ğŸš€ Triggering Frontend deployment..."
        
        if curl -f -X GET "${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}"; then
          echo "âœ… Deploy signal sent successfully!"
        else
          echo "âŒ Failed to trigger deploy."
          exit 1
        fi

    - name: Deployment Summary
      if: success()
      run: |
        echo "ğŸ”— Monitor Deployment: https://dashboard.render.com"
        # Äá»•i link dÆ°á»›i thÃ nh link tháº­t cá»§a báº¡n
        echo "ğŸ‘‰ Live URL: https://airbnb-frontend-xxxx.onrender.com"